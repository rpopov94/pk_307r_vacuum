## **Система контроля вакуума**

Репозиторий содержит код, предназначенный работы с сенсорной панелью  [_owen_ серии СПК 3хх](https://owen.ru/product/sp3xx).

СПК 3хх относится с семейству [ПЛК](https://ru.wikipedia.org/wiki/Программируемый_логический_контроллер) - пользователь программирует его в соотвествии со своими требованиями.

[**Технические требования**](#)

- OC Windows 10 или Linux
- Python >= 3.8
Необходимые библиотеки находятся в файле requirements.txt

[**Установка и запуск**](#)

Запуск проекта:


1. Установить [git](https://git-scm.com/download/win) 
2. Скачать исходный код программы:
- `git clone https://git.jinr.ru/rpopov94/pk_307r_vacuum.git`
4. Установить [Python](https://www.python.org/downloads/)
5. Установить саму программу:
- `cd pk_307r_vacuum`
- `python setup.py install`
6. Для запуска прораммы ввести в терминале имя программы
- `spk_307 <ip>`
- `<ip>` - IP адрес устройства.

_Интерпретатор установит саму программу и все необходимые компоненты_


[**Назначение и интерфейс**](#)

Программа предназначена для мониторинга за состоянием вакуумной системой на 13 канале реактора ИБР-2 (ОИЯИ Дубна), позволяет в режиме реального времени контролировать состояние системы и сохранять данные о работе в файл *.csv

_Главное окно_

![Главное окно](https://git.jinr.ru/rpopov94/pk_307r_vacuum/-/raw/master/imag_readme/main_window.gif)

_Окно настроек_

![Окно настроек](https://git.jinr.ru/rpopov94/pk_307r_vacuum/-/raw/master/imag_readme/ip_settings.png)

_Настройки датчиков вакуума_

![Настройки датчиков вакуума](https://git.jinr.ru/rpopov94/pk_307r_vacuum/-/raw/master/imag_readme/vacuum_settings.png)


[**Обмен данными**](#)

Связь с ПЛК может осуществляться через следующие интерфейсы:  

- [RS232](https://ru.wikipedia.org/wiki/RS-232);

- [RS485](https://ru.wikipedia.org/wiki/RS-485);

- [Ethernet](https://ru.wikipedia.org/wiki/Ethernet);

Обмен данными через компьютер осущетсвляется по протоколу Modbus: 

Modbus — коммуникационный протокол, основан на архитектуре ведущий-ведомый (master-slave). Использует для передачи данных интерфейсы RS-485, RS-422, RS-232, а также Ethernet сети TCP/IP (протокол Modbus TCP).

[modbus](https://ipc2u.ru/articles/prostye-resheniya/modbus-rtu/), [Ethernet](https://ipc2u.ru/articles/prostye-resheniya/modbus-tcp/).

_Modbus RTU_

Сообщение Modbus RTU состоит из адреса устройства SlaveID, кода функции, специальных данных в зависимости от кода функции и CRC контрольной суммы.

| SlaveID | Код функции | Специальные данные | CRC |
| ------ | ------ | ------ | ------ |

_Пример запроса:_

| 11 | 03 | 006B | 0003 | 7687 |
| ------ |  ------ | ------ | ------ | ------ |

Здесь:

| 11 | Адрес устройства SlaveID (17 = 11 hex) |
| ------ | ------ |
| 03 | Функциональный код Function Code (читаем Analog Output Holding Registers) |
| 006B | Адрес первого регистра (40108-40001 = 107 =6B hex) |
| 0003 | Количество требуемых регистров (чтение 3-х регистров с 40108 по 40110) |
| 7687 | Контрольная сумма CRC |

Ответ:

| 11 | 	Адрес устройства (17 = 11 hex) |
| ------ | ------ |
| 03 | Функциональный код |
| 06 | Количество байт далее |
| AE | 	Значение старшего разряда регистра (AE hex) |
| 41 | Значение младшего разряда регистра |
| 56 | Значение старшего разряда регистра |
| 52 | Значение младшего разряда регистра |
| 43 | Значение старшего разряда регистра |
| 40 | Значение младшего разряда регистра |
| 49 | Контрольная сумма Lo |
| AD | Контрольная сумма Hi |


**Modbus TCP**
                                    
В сети Ethernet адресом устройства является его IP-адрес. Обычно устройства находятся в одной подсети, где IP адреса отличаются последними цифрами 192.168.1.20 при использовании самой распространённой маски подсети 255.255.255.0.

Интерфейсом является сеть Ethernet, протоколом передачи данных – TCP/IP.

Используемый TCP-порт: 502.

Из сообщения Modbus RTU удаляется SlaveID адрес в начале и CRC контрольная сумма в конце, что образует PDU, Protocol Data Unit.

_Что такое PDU?_

Из сказанного выше следует, что сообщение Modbus RTU состоит из адреса устройства SlaveID, кода функции, специальных данных в зависимости от кода функции и CRC контрольной суммы.

| SlaveID | Код функции | Специальные данные | CRC |
| ------ | ------ | ------ | ------ |

Если отбросить SlaveID и CRC контрольную сумму, то получится PDU, Protocol Data Unit.

К началу получившегося сообщения PDU добавляется новый 7-байтовый заголовок, который называется MBAP Header (Modbus Application Header). Этот заголовок имеет следующие данные:

_Формат запроса_

| Идентификатор транзакции | Protocol Identifier | Length  | Unit Identifier | Функциональный код | Unit Identifier | Данные |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ |

Интерфейсом является сеть Ethernet, протоколом передачи данных – TCP/IP.

Используемый TCP-порт: 502.

**Transaction Identifier** (Идентификатор транзакции): 2 байта устанавливаются Master, чтобы однозначно идентифицировать каждый запрос. Может быть любыми. Эти байты повторятся устройством Slave в ответе, поскольку ответы устройства Slave не всегда могут быть получены в том же порядке, что и запросы.

**Protocol Identifier**
 (Идентификатор протокола): 2 байта устанавливаются Master, всегда будут = 00 00, что соответствует протоколу Modbus.

Length (Длина): 2 байта устанавливаются Master, идентифицирующие число байтов в сообщении, которые следуют далее. Считается от Unit Identifier до конца сообщения.

**Unit Identifier** (Идентификатор блока или адрес устройства): 1 байт устанавливается Master. Повторяется устройством Slave для однозначной идентификации устройства Slave.

_Запрос_

| 0001 | 0000 | 0009 | 11 | 03 | 06 | 022B | 0064 | 007F |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |

| | |
| ------ | ------ |
| 0001 | Идентификатор транзакции |
| 0000 | Идентификатор протокола |
| 0006 | Длина |
| 11 | Адрес устройства |
| 03 | Функциональный код |
| 006B | Адрес первого регистра |
| 0003 | Количество требуемых регистров |

_Ответ:_

| | |
| ------ | ------ |
| 0001 | Идентификатор транзакции |
| 0000 | Идентификатор протокола |
| 0009 | Длина |
| 11 | Адрес устройства |
| 03 | Функциональный код |
| 06 | Количество байт далее |
| 02 | Значение старшего разряда регистра |
| 2B | Значение младшего разряда регистра |
| 00 | Значение старшего разряда регистра |
| 64 | Значение младшего разряда регистра |
| 00 | Значение старшего разряда регистра |
| 00 | Значение младшего разряда регистра |
| 7F | Значение старшего разряда регистра |

_Более о протоколе **modbus** подробно можно прочесть в ресурсах_

1. Протоколы промышленных сетей, Александра Допплингер
2. Сулимов Ю.И. Электронные промышленные устройства
3. Сеть интернет








